{% extends 'core/base.html' %}
{% load static %}

{% block title %}Book Villa - {{ hotel.name }}{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white text-center py-4">
            <h3 class="mb-0">
                <i class="fas fa-home me-3"></i>Book Entire Villa - {{ hotel.name }}
            </h3>
        </div>
        <div class="card-body p-5">
            <!-- Availability Calendar -->
            <div class="mb-5">
                <h4 class="fw-bold text-primary mb-3">Availability Calendar</h4>
                <div id="villa-calendar" class="border rounded p-3 bg-light shadow-sm"></div>
                <p class="text-muted mt-3 small">
                    <span class="bg-success text-white px-2 py-1 rounded">Green</span> = Confirmed &nbsp;
                    <span class="bg-warning text-dark px-2 py-1 rounded">Yellow</span> = Pending &nbsp;
                    <span class="bg-secondary text-white px-2 py-1 rounded">Grey</span> = Cancelled/Manual
                </p>
                <p class="text-danger fw-bold">Red/Yellow dates are unavailable for booking.</p>
            </div>

            <!-- Booking Form -->
            <form action="{% url 'book_villa' hotel.id %}" method="post">
                {% csrf_token %}
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Check-in Date <span class="text-danger">*</span></label>
                        <input type="text" name="check_in" class="form-control form-control-lg flatpickr" placeholder="Select check-in" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Check-out Date <span class="text-danger">*</span></label>
                        <input type="text" name="check_out" class="form-control form-control-lg flatpickr" placeholder="Select check-out" required>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-success btn-lg w-100 shadow">
                            <i class="fas fa-calendar-check me-2"></i>Request Booking
                        </button>
                    </div>
                </div>
            </form>

            <div class="text-center mt-4">
                <a href="{% url 'hotel_detail' hotel.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Details
                </a>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar Visualization -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('villa-calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth'
            },
            height: 'auto',
            events: [
                {% for booking in hotel.booking_set.all %}
                    {
                        title: '{{ booking.get_status_display }}',
                        start: '{{ booking.check_in }}',
                        end: '{{ booking.check_out|date:"Y-m-d" }}',
                        backgroundColor: '{% if booking.status == "confirmed" %}#28a745{% elif booking.status == "pending" %}#ffc107{% else %}#6c757d{% endif %}',
                        borderColor: '{% if booking.status == "confirmed" %}#28a745{% elif booking.status == "pending" %}#ffc107{% else %}#6c757d{% endif %}',
                        textColor: 'white'
                    },
                {% endfor %}
            ]
        });
        calendar.render();
    });
</script>

<!-- Flatpickr Disable Booked Dates -->
<script>
    const bookedRanges = [
        {% for booking in hotel.booking_set.all %}
            {% if booking.status in ['pending', 'confirmed'] %}
                {from: "{{ booking.check_in }}", to: "{{ booking.check_out }}"},
            {% endif %}
        {% endfor %}
    ];

    flatpickr(".flatpickr", {
        dateFormat: "Y-m-d",
        minDate: "today",
        disable: bookedRanges,
        enableTime: false,
        onChange: function(selectedDates, dateStr, instance) {
            if (instance.element.name === "check_in" && selectedDates[0]) {
                const outPicker = document.querySelector('input[name="check_out"]')._flatpickr;
                if (outPicker) outPicker.set("minDate", selectedDates[0]);
            }
        }
    });
</script>
{% endblock %}